# Coturn TURN Server Configuration
# For WebRTC NAT traversal
# Place this file at: /etc/turnserver.conf

# ==================== LISTENING PORTS ====================

# TURN listener port for UDP and TCP
listening-port=3478

# TLS listening port (TURNS)
tls-listening-port=5349

# Relay ports range
min-port=49152
max-port=65535

# ==================== NETWORKING ====================

# External IP address (replace with your server's public IP)
external-ip=YOUR_SERVER_PUBLIC_IP

# Internal IP (usually private subnet)
# relay-ip=192.168.1.100

# Realm for TURN authentication
realm=yourplatform.com

# Server name
server-name=turn.yourplatform.com

# ==================== AUTHENTICATION ====================

# Use long-term credentials
lt-cred-mech

# User credentials (format: username:password)
# Generate passwords with: turnadmin -k -u username -r realm -p password
user=turnuser:turnpass123

# Or use MongoDB/Redis for user database
# userdb=/var/db/turndb

# ==================== TLS/SSL ====================

# TLS certificate and key (use Let's Encrypt)
cert=/etc/letsencrypt/live/turn.yourplatform.com/fullchain.pem
pkey=/etc/letsencrypt/live/turn.yourplatform.com/privkey.pem

# Disable insecure protocols
no-tlsv1
no-tlsv1_1

# ==================== SECURITY ====================

# Disable UDP for better security (optional)
# no-udp

# Disable TCP (uncomment if UDP-only)
# no-tcp

# Fingerprint authentication
fingerprint

# Disable multi-tenant mode
# Ensures only authenticated users can use the server
no-multicast-peers

# Deny peer-to-peer connections
# denied-peer-ip=0.0.0.0-255.255.255.255

# ==================== PERFORMANCE ====================

# Total quota (bytes per allocation)
user-quota=100

# Total quota (bytes per session)
total-quota=1200

# Max allocations per user
max-bps=3000000

# Worker threads
# proc-user=turnserver
# proc-group=turnserver

# ==================== LOGGING ====================

# Log file
log-file=/var/log/turnserver/turnserver.log

# Verbose logging (disable in production)
# verbose

# Simple log format
simple-log

# ==================== DATABASE (Optional) ====================

# Use Redis for session persistence
# redis-userdb="ip=127.0.0.1 dbname=0 password=redis_password connect_timeout=30"

# Use MongoDB
# mongo-userdb="mongodb://localhost:27017/turn"

# ==================== ADDITIONAL OPTIONS ====================

# Mobility with ICE
mobility

# No CLI
no-cli

# Disable RFC5780 (NAT behavior discovery)
# Improves performance
# no-stun-backward-compatibility

# Prometheus metrics
# prometheus

# ==================== ALLOWED/DENIED PEERS ====================

# Allow only specific IP ranges
# allowed-peer-ip=192.168.1.0-192.168.1.255

# Deny private IP ranges (security)
no-loopback-peers
no-multicast-peers

# ==================== TURN REST API (Optional) ====================

# Enable REST API for dynamic credentials
# use-auth-secret
# static-auth-secret=your-secret-key-here

# ==================== NOTES ====================
# 1. Generate secure passwords: openssl rand -hex 32
# 2. Open firewall ports:
#    sudo ufw allow 3478/tcp
#    sudo ufw allow 3478/udp
#    sudo ufw allow 5349/tcp
#    sudo ufw allow 49152:65535/udp
# 3. Test with: turnutils_uclient -v -u turnuser -w turnpass123 YOUR_SERVER_IP
# 4. Monitor with: sudo journalctl -u coturn -f
